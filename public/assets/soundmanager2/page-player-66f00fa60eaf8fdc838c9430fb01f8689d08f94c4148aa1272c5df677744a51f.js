function PagePlayer(){var e,t,a=this,s=this,i=soundManager,n=null,o=null,l=document.getElementsByTagName("head")[0],r=null,d=navigator.userAgent,u=d.match(/(opera|firefox)/i),c=d.match(/ipad|ipod|iphone/i);this.config={usePeakData:!1,useWaveformData:!1,useEQData:!1,fillGraph:!1,allowRightClick:!0,useThrottling:!0,autoStart:!1,playNext:!0,updatePageTitle:!0,emptyTime:"-:--",useFavIcon:!1},this.css={sDefault:"sm2_link",sLoading:"sm2_loading",sPlaying:"sm2_playing",sPaused:"sm2_paused"},this.sounds=[],this.soundsByObject=[],this.lastSound=null,this.soundCount=0,this.strings=[],this.dragActive=!1,this.dragExec=new Date,this.dragTimer=null,this.pageTitle=document.title,this.lastWPExec=new Date,this.lastWLExec=new Date,this.vuMeterData=[],this.oControls=null,this._mergeObjects=function(e,t){var a,s,i,n={};for(s in e)e.hasOwnProperty(s)&&(n[s]=e[s]);a="undefined"==typeof t?{}:t;for(i in a)"undefined"==typeof n[i]&&(n[i]=a[i]);return n},e=function(){function e(e){var t=n.call(e),a=t.length;return i?(t[1]="on"+t[1],a>3&&t.pop()):3===a&&t.push(!1),t}function t(e,t){var a=e.shift(),s=[o[t]];i?a[s](e[0],e[1]):a[s].apply(a,e)}function a(){t(e(arguments),"add")}function s(){t(e(arguments),"remove")}var i=window.attachEvent&&!window.addEventListener,n=Array.prototype.slice,o={add:i?"attachEvent":"addEventListener",remove:i?"detachEvent":"removeEventListener"};return{add:a,remove:s}}(),this.hasClass=function(e,t){return"undefined"!=typeof e.className?new RegExp("(^|\\s)"+t+"(\\s|$)").test(e.className):!1},this.addClass=function(e,t){return e&&t&&!a.hasClass(e,t)?void(e.className=(e.className?e.className+" ":"")+t):!1},this.removeClass=function(e,t){return e&&t&&a.hasClass(e,t)?void(e.className=e.className.replace(new RegExp("( "+t+")|("+t+")","g"),"")):!1},this.select=function(e,t){var s=a.getByClassName(e,"div",t||null);return s?s[0]:null},this.getByClassName=document.querySelectorAll?function(e,t,a){var s,i="."+e;return t&&(t=t.split(" ")),s=t.length>1?t.join(i+", "):t[0]+i,(a?a:document).querySelectorAll(s)}:function(e,t,s){var i,n,o=s?s:document,l=[],r=[];if(t&&(t=t.split(" ")),t instanceof Array){for(i=t.length;i--;)r&&r[t[i]]||(r[t[i]]=o.getElementsByTagName(t[i]));for(i=t.length;i--;)for(n=r[t[i]].length;n--;)a.hasClass(r[t[i]][n],e)&&l.push(r[t[i]][n])}else for(r=o.all||o.getElementsByTagName("*"),i=0,n=r.length;n>i;i++)a.hasClass(r[i],e)&&l.push(r[i]);return l},this.isChildOfClass=function(e,t){if(!e||!t)return!1;for(;e.parentNode&&!a.hasClass(e,t);)e=e.parentNode;return a.hasClass(e,t)},this.getParentByNodeName=function(e,t){if(!e||!t)return!1;for(t=t.toLowerCase();e.parentNode&&t!==e.parentNode.nodeName.toLowerCase();)e=e.parentNode;return e.parentNode&&t===e.parentNode.nodeName.toLowerCase()?e.parentNode:null},this.getOffX=function(e){var t=0;if(e.offsetParent)for(;e.offsetParent;)t+=e.offsetLeft,e=e.offsetParent;else e.x&&(t+=e.x);return t},this.getTime=function(e,t){var a=Math.floor(e/1e3),s=Math.floor(a/60),i=a-60*s;return t?s+":"+(10>i?"0"+i:i):{min:s,sec:i}},this.getSoundByObject=function(e){return"undefined"!=typeof a.soundsByObject[e.id]?a.soundsByObject[e.id]:null},this.getPreviousItem=function(e){if(e.previousElementSibling)e=e.previousElementSibling;else for(e=e.previousSibling;e&&e.previousSibling&&1!==e.previousSibling.nodeType;)e=e.previousSibling;return"li"!==e.nodeName.toLowerCase()?null:e.getElementsByTagName("a")[0]},this.playPrevious=function(e){if(e||(e=a.lastSound),!e)return!1;var t=a.getPreviousItem(e._data.oLI);return t&&s.handleClick({target:t}),t},this.getNextItem=function(e){if(e.nextElementSibling)e=e.nextElementSibling;else for(e=e.nextSibling;e&&e.nextSibling&&1!==e.nextSibling.nodeType;)e=e.nextSibling;return"li"!==e.nodeName.toLowerCase()?null:e.getElementsByTagName("a")[0]},this.playNext=function(e){if(e||(e=a.lastSound),!e)return!1;var t=a.getNextItem(e._data.oLI);return t&&s.handleClick({target:t}),t},this.setPageTitle=function(e){if(!a.config.updatePageTitle)return!1;try{document.title=(e?e+" - ":"")+a.pageTitle}catch(t){a.setPageTitle=function(){return!1}}},this.events={play:function(){s.removeClass(this._data.oLI,this._data.className),this._data.className=s.css.sPlaying,s.addClass(this._data.oLI,this._data.className),a.setPageTitle(this._data.originalTitle)},stop:function(){s.removeClass(this._data.oLI,this._data.className),this._data.className="",this._data.oPosition.style.width="0px",a.setPageTitle(),a.resetPageIcon()},pause:function(){return s.dragActive?!1:(s.removeClass(this._data.oLI,this._data.className),this._data.className=s.css.sPaused,s.addClass(this._data.oLI,this._data.className),a.setPageTitle(),void a.resetPageIcon())},resume:function(){return s.dragActive?!1:(s.removeClass(this._data.oLI,this._data.className),this._data.className=s.css.sPlaying,void s.addClass(this._data.oLI,this._data.className))},finish:function(){s.removeClass(this._data.oLI,this._data.className),this._data.className="",this._data.oPosition.style.width="0px",a.config.playNext?s.playNext(this):(a.setPageTitle(),a.resetPageIcon())},whileloading:function(){function e(){this._data.oLoading.style.width=this.bytesLoaded/this.bytesTotal*100+"%",!this._data.didRefresh&&this._data.metadata&&(this._data.didRefresh=!0,this._data.metadata.refresh())}if(s.config.useThrottling){var t=new Date;(t&&t-a.lastWLExec>50||this.bytesLoaded===this.bytesTotal)&&(e.apply(this),a.lastWLExec=t)}else e.apply(this)},onload:function(){if(this.loaded)this._data.metadata&&this._data.metadata.refresh();else{var e=this._data.oLI.getElementsByTagName("a")[0],t=e.innerHTML;e.innerHTML=t+' <span style="font-size:0.5em"> | Load failed, d\'oh! '+(i.sandbox.noRemote?" Possible cause: Flash sandbox is denying remote URL access.":i.sandbox.noLocal?"Flash denying local filesystem access":"404?")+"</span>",setTimeout(function(){e.innerHTML=t},5e3)}},whileplaying:function(){var e=null;s.dragActive||!s.config.useThrottling?(a.updateTime.apply(this),i.flashVersion>=9&&(s.config.usePeakData&&this.instanceOptions.usePeakData&&a.updatePeaks.apply(this),(s.config.useWaveformData&&this.instanceOptions.useWaveformData||s.config.useEQData&&this.instanceOptions.useEQData)&&a.updateGraph.apply(this)),this._data.metadata&&(e=new Date,e&&e-a.lastWPExec>500&&(this._data.metadata.refreshMetadata(this),a.lastWPExec=e)),this._data.oPosition.style.width=this.position/a.getDurationEstimate(this)*100+"%"):(e=new Date,e-a.lastWPExec>30&&(a.updateTime.apply(this),i.flashVersion>=9&&(s.config.usePeakData&&this.instanceOptions.usePeakData&&a.updatePeaks.apply(this),(s.config.useWaveformData&&this.instanceOptions.useWaveformData||s.config.useEQData&&this.instanceOptions.useEQData)&&a.updateGraph.apply(this)),this._data.metadata&&this._data.metadata.refreshMetadata(this),this._data.oPosition.style.width=this.position/a.getDurationEstimate(this)*100+"%",a.lastWPExec=e))}},this.setPageIcon=function(e){if(!a.config.useFavIcon||!a.config.usePeakData||!e)return!1;var t=document.getElementById("sm2-favicon");t&&(l.removeChild(t),t=null),t||(t=document.createElement("link"),t.id="sm2-favicon",t.rel="shortcut icon",t.type="image/png",t.href=e,document.getElementsByTagName("head")[0].appendChild(t))},this.resetPageIcon=function(){if(!a.config.useFavIcon)return!1;var e=document.getElementById("favicon");e&&(e.href="/favicon.ico")},this.updatePeaks=function(){var e=this._data.oPeak,t=e.getElementsByTagName("span");t[0].style.marginTop=13-Math.floor(15*this.peakData.left)+"px",t[1].style.marginTop=13-Math.floor(15*this.peakData.right)+"px",i.flashVersion>8&&a.config.useFavIcon&&a.config.usePeakData&&a.setPageIcon(a.vuMeterData[parseInt(16*this.peakData.left,10)][parseInt(16*this.peakData.right,10)])},this.updateGraph=function(){if(s.config.flashVersion<9||!s.config.useWaveformData&&!s.config.useEQData)return!1;var e,t,a,i=this._data.oGraph.getElementsByTagName("div");if(s.config.useWaveformData)for(e=8,t=255;t--;)i[255-t].style.marginTop=1+e+Math.ceil(this.waveformData.left[t]*-e)+"px";else for(a=9,t=255;t--;)i[255-t].style.marginTop=2*a-1+Math.ceil(this.eqData[t]*-a)+"px"},this.resetGraph=function(){if(!s.config.useEQData||s.config.flashVersion<9)return!1;var e,t=this._data.oGraph.getElementsByTagName("div"),a=s.config.useEQData?"17px":"9px",i=s.config.fillGraph?"32px":"1px";for(e=255;e--;)t[255-e].style.marginTop=a,t[255-e].style.height=i},this.updateTime=function(){var e=a.strings.timing.replace("%s1",a.getTime(this.position,!0));e=e.replace("%s2",a.getTime(a.getDurationEstimate(this),!0)),this._data.oTiming.innerHTML=e},this.getTheDamnTarget=function(e){return e.target||(window.event?window.event.srcElement:null)},this.withinStatusBar=function(e){return a.isChildOfClass(e,"playlist")&&a.isChildOfClass(e,"controls")},this.handleClick=function(e){if(2===e.button)return s.config.allowRightClick||s.stopEvent(e),s.config.allowRightClick;var t,n,o,l,d,u,c=a.getTheDamnTarget(e);return c?(a.dragActive&&a.stopDrag(),a.withinStatusBar(c)?!1:("a"!==c.nodeName.toLowerCase()&&(c=a.getParentByNodeName(c,"a")),c?(t=c.getAttribute("href"),!c.href||!i.canPlayLink(c)&&!a.hasClass(c,"playable")||a.hasClass(c,"exclude")?!0:(a.initUL(a.getParentByNodeName(c,"ul")),a.initItem(c),n=c.href,o=a.getSoundByObject(c),o?(a.setPageTitle(o._data.originalTitle),o===a.lastSound?2!==o.readyState?1!==o.playState?o.play():o.togglePause():i._writeDebug("Warning: sound failed to load (security restrictions, 404 or bad format)",2):(a.lastSound&&a.stopSound(a.lastSound),r&&o._data.oTimingBox.appendChild(r),o.togglePause())):(o=i.createSound({id:c.id,url:decodeURI(n),onplay:a.events.play,onstop:a.events.stop,onpause:a.events.pause,onresume:a.events.resume,onfinish:a.events.finish,type:c.type||null,whileloading:a.events.whileloading,whileplaying:a.events.whileplaying,onmetadata:a.events.metadata,onload:a.events.onload}),l=a.oControls.cloneNode(!0),d=c.parentNode,d.appendChild(l),r&&d.appendChild(r),a.soundsByObject[c.id]=o,o._data={oLink:c,oLI:d,oControls:a.select("controls",d),oStatus:a.select("statusbar",d),oLoading:a.select("loading",d),oPosition:a.select("position",d),oTimingBox:a.select("timing",d),oTiming:a.select("timing",d).getElementsByTagName("div")[0],oPeak:a.select("peak",d),oGraph:a.select("spectrum-box",d),className:a.css.sPlaying,originalTitle:c.innerHTML,metadata:null},r&&o._data.oTimingBox.appendChild(r),o._data.oLI.getElementsByTagName("ul").length&&(o._data.metadata=new Metadata(o)),u=a.strings.timing.replace("%s1",a.config.emptyTime),u=u.replace("%s2",a.config.emptyTime),o._data.oTiming.innerHTML=u,a.sounds.push(o),a.lastSound&&a.stopSound(a.lastSound),a.resetGraph.apply(o),o.play()),a.lastSound=o,a.stopEvent(e))):!0)):!0},this.handleMouseDown=function(t){if(c&&t.touches&&(t=t.touches[0]),2===t.button)return s.config.allowRightClick||s.stopEvent(t),s.config.allowRightClick;var i=a.getTheDamnTarget(t);return i&&a.withinStatusBar(i)?(a.dragActive=!0,a.lastSound.pause(),a.setPosition(t),c?e.add(document,"touchmove",a.handleMouseMove):e.add(document,"mousemove",a.handleMouseMove),a.addClass(a.lastSound._data.oControls,"dragging"),a.stopEvent(t)):!0},this.handleMouseMove=function(e){if(c&&e.touches&&(e=e.touches[0]),a.dragActive)if(a.config.useThrottling){var t=new Date;t-a.dragExec>20?a.setPosition(e):(window.clearTimeout(a.dragTimer),a.dragTimer=window.setTimeout(function(){a.setPosition(e)},20)),a.dragExec=t}else a.setPosition(e);else a.stopDrag();return e.stopPropagation=!0,!1},this.stopDrag=function(t){return a.dragActive?(a.removeClass(a.lastSound._data.oControls,"dragging"),c?e.remove(document,"touchmove",a.handleMouseMove):e.remove(document,"mousemove",a.handleMouseMove),s.hasClass(a.lastSound._data.oLI,a.css.sPaused)||a.lastSound.resume(),a.dragActive=!1,a.stopEvent(t)):void 0},this.handleStatusClick=function(e){return a.setPosition(e),s.hasClass(a.lastSound._data.oLI,a.css.sPaused)||a.resume(),a.stopEvent(e)},this.stopEvent=function(e){return"undefined"!=typeof e&&("undefined"!=typeof e.preventDefault?e.preventDefault():(e.stopPropagation=!0,e.returnValue=!1)),!1},this.setPosition=function(e){var t,s,i,n,o=a.getTheDamnTarget(e);if(!o)return!0;for(s=o;!a.hasClass(s,"controls")&&s.parentNode;)s=s.parentNode;i=a.lastSound,t=parseInt(e.clientX,10),n=Math.floor((t-a.getOffX(s)-4)/s.offsetWidth*a.getDurationEstimate(i)),isNaN(n)||(n=Math.min(n,i.duration)),isNaN(n)||i.setPosition(n)},this.stopSound=function(e){i._writeDebug("stopping sound: "+e.id),i.stop(e.id),c||i.unload(e.id)},this.getDurationEstimate=function(e){return e.instanceOptions.isMovieStar?e.duration:e._data.metadata&&e._data.metadata.data.givenDuration?e._data.metadata.data.givenDuration:e.durationEstimate||0},this.createVUData=function(){var e,t,s=0,i=0,o=n.getContext("2d"),l=o.createLinearGradient(0,16,0,0);for(l.addColorStop(0,"rgb(0,192,0)"),l.addColorStop(.3,"rgb(0,255,0)"),l.addColorStop(.625,"rgb(255,255,0)"),l.addColorStop(.85,"rgb(255,0,0)"),e=o.createLinearGradient(0,16,0,0),t="rgba(0,0,0,0.2)",e.addColorStop(0,t),e.addColorStop(1,"rgba(0,0,0,0.5)"),s=0;16>s;s++)a.vuMeterData[s]=[];for(s=0;16>s;s++)for(i=0;16>i;i++)n.setAttribute("width",16),n.setAttribute("height",16),o.fillStyle=e,o.fillRect(0,0,7,15),o.fillRect(8,0,7,15),o.fillStyle=l,o.fillRect(0,15-s,7,16-(16-s)),o.fillRect(8,15-i,7,16-(16-i)),o.clearRect(0,3,16,1),o.clearRect(0,7,16,1),o.clearRect(0,11,16,1),a.vuMeterData[s][i]=n.toDataURL("image/png")},this.testCanvas=function(){var e,t=document.createElement("canvas"),a=null;if(!t||"undefined"==typeof t.getContext)return null;if(a=t.getContext("2d"),!a||"function"!=typeof t.toDataURL)return null;try{e=t.toDataURL("image/png")}catch(s){return null}return t},this.initItem=function(e){e.id||(e.id="pagePlayerMP3Sound"+a.soundCount++),a.addClass(e,a.css.sDefault)},this.initUL=function(e){i.flashVersion>=9&&a.addClass(e,a.cssBase)},this.init=function(l){function d(s){e[s](document,"click",a.handleClick),c?(e[s](document,"touchstart",a.handleMouseDown),e[s](document,"touchend",a.stopDrag)):(e[s](document,"mousedown",a.handleMouseDown),e[s](document,"mouseup",a.stopDrag)),e[s](window,"unload",t)}l?(i._writeDebug("pagePlayer.init(): Using custom configuration"),this.config=this._mergeObjects(l,this.config)):i._writeDebug("pagePlayer.init(): Using default configuration");var h,g,f,p,m,v;if(this.cssBase=[],i.useFlashBlock=!0,i.flashVersion>=9?(i.defaultOptions.usePeakData=this.config.usePeakData,i.defaultOptions.useWaveformData=this.config.useWaveformData,i.defaultOptions.useEQData=this.config.useEQData,this.config.usePeakData&&this.cssBase.push("use-peak"),(this.config.useWaveformData||this.config.useEQData)&&this.cssBase.push("use-spectrum"),this.cssBase=this.cssBase.join(" "),this.config.useFavIcon&&(n=a.testCanvas(),n&&u?a.createVUData():this.config.useFavIcon=!1)):(this.config.usePeakData||this.config.useWaveformData||this.config.useEQData)&&i._writeDebug("Page player: Note: soundManager.flashVersion = 9 is required for peak/waveform/EQ features."),o=document.createElement("div"),o.innerHTML=['  <div class="controls">','   <div class="statusbar">','    <div class="loading"></div>','    <div class="position"></div>',"   </div>","  </div>",'  <div class="timing">','   <div id="sm2_timing" class="timing-data">','    <span class="sm2_position">%s1</span> / <span class="sm2_total">%s2</span>',"   </div>","  </div>",'  <div class="peak">','   <div class="peak-box"><span class="l"></span><span class="r"></span></div>',"  </div>",' <div class="spectrum-container">','  <div class="spectrum-box">','   <div class="spectrum"></div>',"  </div>"," </div>"].join("\n"),i.flashVersion>=9){for(r=a.select("spectrum-container",o),r=o.removeChild(r),g=a.select("spectrum-box",r),f=g.getElementsByTagName("div")[0],p=document.createDocumentFragment(),m=null,h=256;h--;)m=f.cloneNode(!1),m.style.left=h+"px",p.appendChild(m);g.removeChild(f),g.appendChild(p)}else o.removeChild(a.select("spectrum-container",o)),o.removeChild(a.select("peak",o));a.oControls=o.cloneNode(!0),v=a.select("timing-data",o),a.strings.timing=v.innerHTML,v.innerHTML="",v.id="",t=function(){d("remove")},d("add"),i._writeDebug("pagePlayer.init(): Ready",1),a.config.autoStart&&s.handleClick({target:s.getByClassName("playlist","ul")[0].getElementsByTagName("a")[0]})}}var pagePlayer=null;soundManager.useFlashBlock=!0,soundManager.onready(function(){pagePlayer=new PagePlayer,pagePlayer.init("undefined"!=typeof PP_CONFIG?PP_CONFIG:null)});